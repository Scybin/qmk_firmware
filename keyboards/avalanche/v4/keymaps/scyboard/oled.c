#include QMK_KEYBOARD_H
#include "oled_state.h"

// Bitmap for "scyboard" (128x64 OLED screen)
static const unsigned char PROGMEM scyboard_logo[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfe, 0xfe, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 
    0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x80, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 
    0x00, 0x00, 0x80, 0xf8, 0xfe, 0xff, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x7f, 0xff, 0xfc, 0xf0, 0x00, 
    0x00, 0x00, 0x00, 0xe0, 0xf8, 0xfe, 0x7f, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x3f, 0xff, 0xfc, 0xe0, 
    0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xfe, 0xff, 0x7f, 0x07, 
    0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0xff, 0xff, 0xf8, 0x80, 
    0x00, 0x00, 0x00, 0x00, 0xe0, 0xf8, 0xfe, 0x7f, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x3f, 0xff, 0xfc, 
    0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfc, 0xfe, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0xff, 
    0xff, 0xfc, 0x80, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 
    0x00, 0x80, 0xf0, 0xfc, 0xff, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0x7e, 0xff, 0xff, 0xff, 0x07, 
    0x00, 0x00, 0x07, 0x7f, 0xff, 0xff, 0xf0, 0xf0, 0xe0, 0xc0, 0xc0, 0x80, 0x01, 0x01, 0x01, 0x00, 
    0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 
    0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0xc0, 0xfc, 0xff, 0x7f, 0x07, 0x00, 0x00, 
    0x00, 0x80, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0xff, 0xff, 0xff, 
    0x00, 0x00, 0x80, 0xfe, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 
    0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xff, 
    0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0xf8, 0xff, 0xff, 0x3f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x7f, 0x00, 
    0x00, 0xc0, 0xc0, 0x80, 0x00, 0x01, 0x01, 0x03, 0x07, 0x07, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 
    0x00, 0x3f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xe0, 0xfc, 0xff, 0x7f, 0x07, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 0x07, 
    0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xfc, 0xff, 
    0xff, 0x0f, 0x00, 0x00, 0xf0, 0xfe, 0xff, 0x3f, 0x07, 0x01, 0x01, 0x00, 0x00, 0x00, 0xf0, 0xff, 
    0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 0x00, 0x00, 
    0x00, 0x1f, 0x7f, 0xff, 0xfc, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xfe, 0x7f, 0x3f, 0x07, 0x00, 0x00, 
    0x00, 0x00, 0x0f, 0x3f, 0xff, 0xfc, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xfe, 0x7f, 0x1f, 0x03, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0x7f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0xfc, 0xff, 0xff, 0x7f, 0xfe, 0xf8, 0xf0, 0xf0, 0xf0, 0xf8, 0xfe, 0xff, 0x3f, 0x0f, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x07, 0x3f, 0xff, 0xfc, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xfc, 0x7f, 0x3f, 0x0f, 
    0x01, 0x00, 0x00, 0x00, 0x0f, 0x7f, 0xff, 0xfe, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0x7e, 0xff, 0xff, 
    0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x03, 0x3f, 0xff, 0xff, 0xf8, 0xf0, 0xf0, 0xf0, 0xf8, 0x7c, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0xc0, 0xfc, 0xff, 0x7f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 
    0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 
    0x7e, 0x7e, 0x7f, 0x3f, 0x0f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

// Layer names for display
static const char *layer_names[] = {
    "BASE", "LIGHT", "DEV", "OSRS", "LOWER", "UPPER"
};

static void oled_write_line(uint8_t row, const char *text) {
    oled_set_cursor(0, row);
    oled_write(text, false);
}

static void oled_write_formatted(uint8_t row, const char *format, ...) {
    char buffer[32];
    va_list args;
    va_start(args, format);
    vsnprintf(buffer, sizeof(buffer), format, args);
    va_end(args);
    oled_write_line(row, buffer);
}

bool oled_task_user(void) {
    if (is_keyboard_master()) {
        oled_on();
        oled_clear();

        uint8_t current_layer = biton32(layer_state);
        oled_set_cursor(0, 0);
        oled_write_P(PSTR("Layer: "), false);
        oled_write(layer_names[current_layer], false);

        for (uint8_t row = 0; row < MATRIX_ROWS; row++) {
            matrix_row_t current_row = matrix_get_row(row);
            for (uint8_t col = 0; col < MATRIX_COLS; col++) {
                bool was_pressed = get_previous_matrix_row(row) & (1 << col);
                bool is_pressed = current_row & (1 << col);

                if (is_pressed && !was_pressed) {
                    process_keypress(row, col, current_layer);
                    break;
                }
            }
            set_previous_matrix_row(row, current_row);
        }

        if (get_last_keycode() != 0) {
            oled_write_formatted(2, "Row: %d Col: %d", get_last_row(), get_last_col());
            oled_write_formatted(4, "KC: 0x%04X - %05d", get_last_keycode(), get_last_keycode());
        } else {
            oled_write_line(2, "Row: None Col: None");
            oled_write_line(4, "KC: None");
        }

        oled_write_formatted(6, "Chars: %lu", get_total_characters());
    } else {
        oled_on();
        oled_clear();
        oled_write_raw_P((const char *)scyboard_logo, sizeof(scyboard_logo));
    }

    return false;
}
