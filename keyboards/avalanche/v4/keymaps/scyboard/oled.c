#include QMK_KEYBOARD_H
#include "keycode_utils.h"

// Bitmap for "scyboard" (128x64 OLED screen)
static const unsigned char PROGMEM scyboard_logo[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfe, 0xfe, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 
	0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80, 0x80, 0x80, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 
	0x00, 0x00, 0x80, 0xf8, 0xfe, 0xff, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x7f, 0xff, 0xfc, 0xf0, 0x00, 
	0x00, 0x00, 0x00, 0xe0, 0xf8, 0xfe, 0x7f, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x3f, 0xff, 0xfc, 0xe0, 
	0x00, 0x00, 0x03, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xfe, 0xff, 0x7f, 0x07, 
	0x00, 0x00, 0xf8, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0xff, 0xff, 0xf8, 0x80, 
	0x00, 0x00, 0x00, 0x00, 0xe0, 0xf8, 0xfe, 0x7f, 0x1f, 0x0f, 0x0f, 0x0f, 0x0f, 0x3f, 0xff, 0xfc, 
	0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf0, 0xfc, 0xfe, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0xff, 
	0xff, 0xfc, 0x80, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 
	0x00, 0x80, 0xf0, 0xfc, 0xff, 0x3f, 0x1f, 0x0f, 0x0f, 0x0f, 0x1f, 0x7e, 0xff, 0xff, 0xff, 0x07, 
	0x00, 0x00, 0x07, 0x7f, 0xff, 0xff, 0xf0, 0xf0, 0xe0, 0xc0, 0xc0, 0x80, 0x01, 0x01, 0x01, 0x00, 
	0x00, 0x00, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x07, 0x07, 
	0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 0xc0, 0xfc, 0xff, 0x7f, 0x07, 0x00, 0x00, 
	0x00, 0x80, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0xff, 0xff, 0xff, 
	0x00, 0x00, 0x80, 0xfe, 0xff, 0xff, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0xff, 
	0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xff, 
	0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0xf0, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xf8, 0xff, 0xff, 0x3f, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0xff, 0x7f, 0x00, 
	0x00, 0xc0, 0xc0, 0x80, 0x00, 0x01, 0x01, 0x03, 0x07, 0x07, 0x1f, 0xff, 0xff, 0xf8, 0x00, 0x00, 
	0x00, 0x3f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xe0, 0xfc, 0xff, 0x7f, 0x07, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 0x07, 
	0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xfc, 0xff, 
	0xff, 0x0f, 0x00, 0x00, 0xf0, 0xfe, 0xff, 0x3f, 0x07, 0x01, 0x01, 0x00, 0x00, 0x00, 0xf0, 0xff, 
	0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xff, 0xff, 0xff, 0x00, 0x00, 
	0x00, 0x1f, 0x7f, 0xff, 0xfc, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xfe, 0x7f, 0x3f, 0x07, 0x00, 0x00, 
	0x00, 0x00, 0x0f, 0x3f, 0xff, 0xfc, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xfe, 0x7f, 0x1f, 0x03, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 0xff, 0x7f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0xfc, 0xff, 0xff, 0x7f, 0xfe, 0xf8, 0xf0, 0xf0, 0xf0, 0xf8, 0xfe, 0xff, 0x3f, 0x0f, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x07, 0x3f, 0xff, 0xfc, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0xfc, 0x7f, 0x3f, 0x0f, 
	0x01, 0x00, 0x00, 0x00, 0x0f, 0x7f, 0xff, 0xfe, 0xf0, 0xf0, 0xf0, 0xf0, 0xf8, 0x7e, 0xff, 0xff, 
	0xff, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x03, 0x3f, 0xff, 0xff, 0xf8, 0xf0, 0xf0, 0xf0, 0xf8, 0x7c, 0xff, 0xff, 0xff, 0x03, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0xc0, 0xfc, 0xff, 0x7f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 
	0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 
	0x7e, 0x7e, 0x7f, 0x3f, 0x0f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

bool oled_task_user(void) {
    // Static variables to store the last pressed key's information
    static uint16_t last_keycode = 0;
    static bool key_pressed = false;

    // Custom OLED logic
    if (is_keyboard_master()) {
        oled_clear();

        uint8_t current_layer = biton32(layer_state);

        // Display the current layer at the top row
        oled_set_cursor(0, 0);
        oled_write_P(PSTR("Layer: "), false);

        // Map the current layer to its name
        switch (current_layer) {
            case 0:
                oled_write_P(PSTR("BASE"), false);
                break;
            case 1:
                oled_write_P(PSTR("LIGHT"), false);
                break;
            case 2:
                oled_write_P(PSTR("DEV"), false);
                break;
            case 3:
                oled_write_P(PSTR("OSRS"), false);
                break;
            case 4:
                oled_write_P(PSTR("LOWER"), false);
                break;
            case 5:
                oled_write_P(PSTR("UPPER"), false);
                break;
        }

        // Move cursor one row below the "Layer" text
        oled_set_cursor(0, 2);

        // Iterate through the matrix to find a pressed key
        bool current_key_found = false;
        for (uint8_t row = 0; row < MATRIX_ROWS; row++) {
            for (uint8_t col = 0; col < MATRIX_COLS; col++) {
                if (matrix_is_on(row, col)) {
                    current_key_found = true;

                    // Update the last pressed key's information
                    last_row = row;
                    last_col = col;
                    last_keycode = keymap_key_to_keycode(current_layer, (keypos_t){.row = row, .col = col});
                    key_pressed = true;

                    break; // Exit inner loop
                }
            }
            if (current_key_found) {
                break; // Exit outer loop
            }
        }

        // Display row and column
        if (key_pressed) {
            char keycode_str[32];
            const char* key_name = get_keycode_name(last_keycode); // Get the key name
            snprintf(keycode_str, sizeof(keycode_str), "KC: %s", key_name);
            oled_write(keycode_str, false);
        } else {
            oled_write_P(PSTR("KC: None"), false);
        }

        // Move cursor one row below the row and column display
        oled_set_cursor(0, 4);

        // Display the keycode and its name
        if (key_pressed) {
            char keycode_str[32];
            const char *key_name = get_u16_str(last_keycode, '0'); // Correct usage
            snprintf(keycode_str, sizeof(keycode_str), "KC: 0x%X - %s", last_keycode, key_name);
            oled_write(keycode_str, false);
        } else {
            oled_write_P(PSTR("KC: None"), false);
        }

        // Move cursor two rows below the keycode tracker
        oled_set_cursor(0, 6);

        // Display the WPM (Words Per Minute)
        char wpm_str[16];
        snprintf(wpm_str, sizeof(wpm_str), "WPM: %d", get_current_wpm());
        oled_write(wpm_str, false);

    } else {
        // Slave OLED display
        oled_clear();
        oled_write_raw_P((const char *)scyboard_logo, sizeof(scyboard_logo));
    }

    return false; // Return false to prevent fallback to default logic
}
